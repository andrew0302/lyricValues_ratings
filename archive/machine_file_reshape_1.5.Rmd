---
title: "machine_file_reshape"
author: "Andrew M. Demetriou"
date: "12/9/2021"
---

```{r}
library('here')            # file logistics
library('data.table')      # data manipulation
library('dplyr')           # data manipulation
library('rlang')           # access variables in dplyr work flow
```


Read in a raw file, and format data table:

```{r}
machine_file_reshape <- function(file){
  
  #read in data file
  machine_dt <- fread(here(data_file_path, file))
  
  #set column names to upper case
  setnames(machine_dt, toupper(names(machine_dt)))
  
  #set column names and order to match participant data set
  setnames(machine_dt, "SONG_ID", "item_ID")
  setnames(machine_dt, "SELF-DIRECTION", "SELF")
  
  #create machine ID column, and erase useless column
  machine_dt[, machine_ID := ..file][,V1:=NULL]

  #set column order to match participant order
  machine_dt <- machine_dt[, c("machine_ID", "item_ID", "ACHIEVEMENT", "BENEVOLENCE", "CONFORMITY", "HEDONISM", "POWER",  "SECURITY", "SELF", "STIMULATION",  "TRADITION", "UNIVERSALISM")]

  #names of values  
  value_names <- c("ACHIEVEMENT", "BENEVOLENCE", "CONFORMITY", "HEDONISM", "POWER",  "SECURITY", "SELF", "STIMULATION",  "TRADITION", "UNIVERSALISM")

  #pivot to wide format
  machine_dt <- dcast(machine_dt, item_ID ~ machine_ID, value.var = value_names) 
}
```

Average multiple runs into a single file:

```{r}
summarize_machine_run  <- function(list_of_machine_data_tables, file_name, setup_name){

  #select data tables by file name
  data_table <- list_of_machine_data_tables[names(list_of_machine_data_tables) %in% file_name]%>%
    # bind data tables into a single data table
    rbindlist(., use.names=FALSE, idcol=TRUE)

  #list of schwartz values
  values <- c("ACHIEVEMENT", "BENEVOLENCE", "CONFORMITY", "HEDONISM", "POWER", "SECURITY", "SELF", "STIMULATION", "TRADITION", "UNIVERSALISM")
  
  #make list of column names
  cols <- lapply(values, function(i){
  #paste0(i, "_", names(file_name))
  paste0(i, "_", setup_name)
  })
  
  #clean up data_table column names
  colnames(data_table) <- c(
    "trial", "item_ID", 
    cols[[1]], cols[[2]], cols[[3]], cols[[4]], 
    cols[[5]], cols[[6]], cols[[7]], cols[[8]],
    cols[[9]], cols[[10]])
  
  #summarize runs
  data_table <- data_table %>%
    group_by(item_ID) %>%
    summarize(
      !! cols[[1]]  := mean(!! rlang::sym(cols[[1]])),
      !! cols[[2]]  := mean(!! rlang::sym(cols[[2]])),
      !! cols[[3]]  := mean(!! rlang::sym(cols[[3]])),
      !! cols[[4]]  := mean(!! rlang::sym(cols[[4]])),
      !! cols[[5]]  := mean(!! rlang::sym(cols[[5]])),
      !! cols[[6]]  := mean(!! rlang::sym(cols[[6]])),
      !! cols[[7]]  := mean(!! rlang::sym(cols[[7]])),
      !! cols[[8]]  := mean(!! rlang::sym(cols[[8]])),
      !! cols[[9]]  := mean(!! rlang::sym(cols[[9]])),
      !! cols[[10]] := mean(!! rlang::sym(cols[[10]])),
    )
}
```

```{r}
#file_name <- file_names[[1]]
#t <- summarize_machine_run(list_of_machine_data_tables, file_names[[1]], setup_names[1])
#list_of_summarized_machine_runs <- list()
#list_of_summarized_machine_runs[[1]] <- summarize_machine_run(list_of_machine_data_tables, file_name = file_names[[1]])
```

Gather multiple runs of multiple machine setups into a list of summaries

```{r}
gather_summarized_machine_runs <- function(list_of_machine_data_tables, file_names, setup_names){
  #make empty list to populate
  list_of_summarized_machine_runs <- list()

  for(i in 1:length(file_names)){
    setup_name <- setup_names[i]
    file_name <- file_names[[i]]
    names(file_name) <- names(file_names)[i]
    #pass above variables to function:
    machine_runs <- summarize_machine_run(list_of_machine_data_tables, file_name, setup_name)
    #append to list
    list_of_summarized_machine_runs[[i]] <- machine_runs
}
  #give list items names
  names(list_of_summarized_machine_runs) <- names(file_names)
  
  return(list_of_summarized_machine_runs)
}
```

Specify path, and create a list of file names:

```{r}
# path with data
data_file_path <- here("data/outputs")

# files
data_files <- list.files(data_file_path)
```

```{r}
t <- function(data_files){
  ## average scores from multiple machine runs
  
  # create a list of data tables and reshape
  list_of_machine_data_tables <- lapply(data_files, machine_file_reshape)
  
  #create list of file names (excluding the last one)
  names(list_of_machine_data_tables) <- data_files

  # make a list of strings to represent each series of runs:
  mxm_faruqi_uniform <- lapply(seq(1,9,1), function(i){paste0("mxm_faruqui_", i, "_uniform_weight_lyrics.txt")})
  mxm_faruqi_idf     <- lapply(seq(1,9,1), function(i){paste0("mxm_faruqui_", i, "_idf_weight_lyrics.txt")})
  mxm_split_uniform  <- lapply(seq(1,9,1), function(i){paste0("mxm_split_",   i, "_uniform_weight_lyrics.txt")})
  mxm_split_idf      <- lapply(seq(1,9,1), function(i){paste0("mxm_split_",   i, "_idf_weight_lyrics.txt")})

  # create a list of file lists
  file_names <- list(mxm_faruqi_uniform, mxm_faruqi_idf, mxm_split_uniform, mxm_split_idf)

  # name the elements in the list after the machine setup used to run
  setup_names <- c("mxm_faruqi_uniform", "mxm_faruqi_idf", "mxm_split_uniform", "mxm_split_idf")

  # create a list of configurations
  names(file_names) <- setup_names
  
  #summarize machine runs
  list_of_summarized_machine_runs <- gather_summarized_machine_runs(list_of_machine_data_tables, file_names, setup_names)
  
  ## format remaining data files
  list_of_machine_data_tables <- list_of_machine_data_tables[1:4]

  # extract column names
  cols <- lapply(list_of_machine_data_tables, colnames)

  # remove extra characters from column names
  clean_cols <- lapply(cols, function(i){
    gsub("_weight_lyrics.txt", "", i)  
  })

  # rename columns in list of data tables
  for(i in 1:length(list_of_machine_data_tables)){
    colnames(list_of_machine_data_tables[[i]]) <- clean_cols[[i]]
  }

  #merge two lists of data tables
  complete_list_of_outputs <- c(list_of_machine_data_tables, list_of_summarized_machine_runs)

  #clear junk
  rm(complete_list_of_outputs, list_of_machine_data_tables, list_of_summarized_machine_runs, file_names, i, setup_names,   data_files, data_file_path, mxm_faruqi_idf, mxm_faruqi_uniform, mxm_split_idf, mxm_split_uniform)

  #merge into a single data table:
  big_ass_data_table = Reduce(function(...) merge(..., all = TRUE), complete_list_of_outputs)
    
}
```



Make a list of formatted data tables, file names, and configurations:

```{r}
#create list of data tables (excluding the last one)
list_of_machine_data_tables <- lapply(data_files[1:44], machine_file_reshape)

#create list of file names (excluding the last one)
names(list_of_machine_data_tables) <- data_files[1:44]

# make a list of strings to represent each series of runs:
mxm_faruqi_uniform <- lapply(seq(1,9,1), function(i){paste0("mxm_faruqui_", i, "_uniform_weight_lyrics.txt")})
mxm_faruqi_idf     <- lapply(seq(1,9,1), function(i){paste0("mxm_faruqui_", i, "_idf_weight_lyrics.txt")})
mxm_split_uniform  <- lapply(seq(1,9,1), function(i){paste0("mxm_split_",   i, "_uniform_weight_lyrics.txt")})
mxm_split_idf      <- lapply(seq(1,9,1), function(i){paste0("mxm_split_",   i, "_idf_weight_lyrics.txt")})

# create a list of file lists
file_names <- list(mxm_faruqi_uniform, mxm_faruqi_idf, mxm_split_uniform, mxm_split_idf)

# name the elements in the list after the machine setup used to run
setup_names <- c("mxm_faruqi_uniform", "mxm_faruqi_idf", "mxm_split_uniform", "mxm_split_idf")

# create a list of configurations
names(file_names) <- setup_names
```

```{r}
list_of_summarized_machine_runs <- gather_summarized_machine_runs(list_of_machine_data_tables, file_names, setup_names)
```

Select the remaining data tables and reformat column names:

```{r}
list_of_machine_data_tables <- list_of_machine_data_tables[1:4]

cols <- lapply(list_of_machine_data_tables, colnames)

clean_cols <- lapply(cols, function(i){
  gsub("_weight_lyrics.txt", "", i)  
})

for(i in 1:length(list_of_machine_data_tables)){
  colnames(list_of_machine_data_tables[[i]]) <- clean_cols[[i]]
}
```

Merge all data tables into one big table:

```{r}
#merge two lists of data tables
complete_list_of_outputs <- c(list_of_machine_data_tables, list_of_summarized_machine_runs)

#merge into a single data table:
big_ass_data_table = Reduce(function(...) merge(..., all = TRUE), complete_list_of_outputs)

#clear junk
rm(complete_list_of_outputs, list_of_machine_data_tables, list_of_summarized_machine_runs, file_names, i, setup_names, data_files, data_file_path, mxm_faruqi_idf, mxm_faruqi_uniform, mxm_split_idf, mxm_split_uniform)
```